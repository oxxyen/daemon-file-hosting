# File Exchange Daemon

> **Privacy is a feature. Intelligence is a discipline.**

–î–µ–º–æ–Ω –Ω–∞ —è–∑—ã–∫–µ C –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –æ–±–º–µ–Ω–∞ —Ñ–∞–π–ª–∞–º–∏ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –≤ MongoDB. –°–∏—Å—Ç–µ–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

## üìå –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ü–µ–ª–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —á–µ—Ä–µ–∑ `inotify` (Linux)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ:
  - –ù–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤ (`IN_MOVED_TO`)
  - –£–¥–∞–ª—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (`IN_DELETE`, `IN_MOVED_FROM`)
  - –ò–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (`IN_CLOSE_WRITE`)
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ MIME-—Ç–∏–ø–∞ –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é
- –ó–∞–ø–∏—Å—å –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –≤ MongoDB:
  - –ò–º—è —Ñ–∞–π–ª–∞
  - –†–∞–∑–º–µ—Ä (–≤ –±–∞–π—Ç–∞—Ö)
  - MIME-—Ç–∏–ø
  - –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–ø—É—Å–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ (—á–µ—Ä–µ–∑ PID-—Ñ–∞–π–ª)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `/tmp/exchange-daemon.log`
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (`SIGINT`, `SIGTERM`)

## üõ†Ô∏è –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Linux (—Ç—Ä–µ–±—É–µ—Ç—Å—è `inotify`)
- GCC –∏–ª–∏ Clang
- [MongoDB](https://www.mongodb.com/) (–ª–æ–∫–∞–ª—å–Ω—ã–π –∏–ª–∏ —É–¥–∞–ª—ë–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä)
- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏:
  - `libmongoc-1.0`
  - `libbson-1.0`

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (Ubuntu/Debian):

```bash
sudo apt install libmongoc-dev libbson-dev
```

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
.
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ main.c               # –û—Å–Ω–æ–≤–Ω–æ–π –¥–µ–º–æ–Ω
‚îÇ   ‚îî‚îÄ‚îÄ db/
‚îÇ       ‚îú‚îÄ‚îÄ mongo_ops.c      # –û–ø–µ—Ä–∞—Ü–∏–∏ —Å MongoDB
‚îÇ       ‚îî‚îÄ‚îÄ mongo_ops.h
‚îú‚îÄ‚îÄ Makefile
‚îî‚îÄ‚îÄ README.md
```
## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞
### 1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ MongoDB –∑–∞–ø—É—â–µ–Ω:
```bash
sudo systemctl start mongod
```

### 2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –æ–±–º–µ–Ω–∞ –≤ src/main.c:
```C
#define EXCHANGE_DIR "/home/just/mesh_proto/oxxyen_storage/file_dir/filetrade"
```
>üí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å —Å –ø—Ä–∞–≤–∞–º–∏ –Ω–∞ —á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –æ—Ç –∫–æ—Ç–æ—Ä–æ–≥–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –¥–µ–º–æ–Ω.

### 3.–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏–∑–º–µ–Ω–∏—Ç–µ URI –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MongoDB:
```C
g_mongo_client = mongoc_client_new("mongodb://localhost:27017");
```

## üèóÔ∏è –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫
```
make
sudo ./exchange-daemon
```
> üîê –î–µ–º–æ–Ω —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ /tmp –∏ –¥–æ—Å—Ç—É–ø –∫ —Ü–µ–ª–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏. –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –æ—Ç –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–∞–≤–∞ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

### –õ–æ–≥–∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤: /tmp/exchange-daemon.log

## –î–∞–Ω–Ω—ã–µ –≤ MongoDB
```bson
{
  "_id": ObjectId("..."),
  "filename": "example.pdf",
  "size": 123456,
  "mime_type": "application/pdf",
  "last_modified": { "$date": "2025-10-25T18:30:45.123Z" }
}
```

## üßπ –û—Å—Ç–∞–Ω–æ–≤–∫–∞
### –î–µ–º–æ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ä–∞–±–æ—Ç—É –ø–æ —Å–∏–≥–Ω–∞–ª–∞–º:
```bash
kill $(cat /tmp/exchange-daemon.pid)
```

üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –î–µ–º–æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–µ (`daemon(1, 1)`)
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `system()` –∏–ª–∏ `popen()` ‚Äî –∏—Å–∫–ª—é—á–µ–Ω—ã –∏–Ω—ä–µ–∫—Ü–∏–∏
- –í—Å–µ –ø—É—Ç–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `snprintf` —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–ª–∏–Ω—ã
- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã (MongoDB, inotify) –æ—Å–≤–æ–±–æ–∂–¥–∞—é—Ç—Å—è –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è (–≤ –±—É–¥—É—â–µ–º)

üìú –õ–∏—Ü–µ–Ω–∑–∏—è

–ü—Ä–æ–µ–∫—Ç —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ–¥ –ª–∏—Ü–µ–Ω–∑–∏–µ–π MIT ‚Äî –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ —Ñ–∞–π–ª–µ `LICENSE`.

–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ —Å –∑–∞–±–æ—Ç–æ–π –æ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏ –∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏.  
–ü–æ–¥–¥–µ—Ä–∂–∫–∞: [@lyr7](https://t.me/lyr7x)
